#!/bin/bash

# SmartStock Pro Enterprise - Universal System Diagnosis
# This script identifies why the software stack might not be loading in both Docker and Native modes.

# Text Formatting
BOLD='\033[1m'
GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
NC='\033[0m' 

echo -e "${BOLD}====================================================${NC}"
echo -e "${BOLD}   SmartStock Pro Enterprise - Universal Diagnosis  ${NC}"
echo -e "${BOLD}====================================================${NC}"

# 1. Environment Variables Check
echo -e "\n${BOLD}[1/6] Checking Environment Configuration${NC}"
if [ -f .env ]; then
    echo -e "  [${GREEN}OK${NC}] .env file exists."
    # Use grep to safely extract variables without executing the whole file
    ENV_API_KEY=$(grep "^API_KEY=" .env | cut -d'=' -f2-)
    ENV_DB_HOST=$(grep "^DB_HOST=" .env | cut -d'=' -f2-)
    ENV_DB_USER=$(grep "^DB_USER=" .env | cut -d'=' -f2-)
    ENV_DB_PASS=$(grep "^DB_PASSWORD=" .env | cut -d'=' -f2-)

    if [ -z "$ENV_API_KEY" ]; then
        echo -e "  [${RED}FAIL${NC}] API_KEY is empty in .env."
    else
        echo -e "  [${GREEN}OK${NC}] API_KEY is present."
    fi
    
    # Check for Docker vs Native settings
    if [ "$ENV_DB_HOST" == "db" ]; then
        echo -e "  [${CYAN}INFO${NC}] Configured for ${BOLD}Docker Mode${NC} (DB_HOST=db)."
        RUN_MODE="DOCKER"
    else
        HOST_DISPLAY=${ENV_DB_HOST:-"localhost (default)"}
        echo -e "  [${CYAN}INFO${NC}] Configured for ${BOLD}Native Mode${NC} (DB_HOST=$HOST_DISPLAY)."
        RUN_MODE="NATIVE"
        DB_HOST_ACTUAL=${ENV_DB_HOST:-"127.0.0.1"}
    fi
else
    echo -e "  [${RED}FAIL${NC}] .env file is missing."
    exit 1
fi

# 2. Service/Process Check
echo -e "\n${BOLD}[2/6] Checking Core Services ($RUN_MODE)${NC}"
if [ "$RUN_MODE" == "DOCKER" ]; then
    if ! command -v docker &> /dev/null; then
        echo -e "  [${RED}FAIL${NC}] Docker is not installed but DB_HOST is set to 'db'."
    else
        APP_STATUS=$(docker ps -a --filter "name=smartstock-app" --format "{{.Status}}")
        DB_STATUS=$(docker ps -a --filter "name=smartstock-db" --format "{{.Status}}")
        [[ $APP_STATUS == Up* ]] && echo -e "  [${GREEN}OK${NC}] App Container: $APP_STATUS" || echo -e "  [${RED}FAIL${NC}] App Container DOWN."
        [[ $DB_STATUS == Up* ]] && echo -e "  [${GREEN}OK${NC}] DB Container: $DB_STATUS" || echo -e "  [${RED}FAIL${NC}] DB Container DOWN."
    fi
else
    # Native checks
    if pgrep -x "node" > /dev/null; then
        echo -e "  [${GREEN}OK${NC}] Node.js process is running."
    else
        echo -e "  [${RED}FAIL${NC}] No Node.js process found. Run 'npm start' or 'node server.js'."
    fi
    
    if pgrep -x "mariadbd" > /dev/null || pgrep -x "mysqld" > /dev/null; then
        echo -e "  [${GREEN}OK${NC}] MariaDB/MySQL service is running locally."
    else
        echo -e "  [${RED}FAIL${NC}] MariaDB service not found. Try 'sudo systemctl start mariadb'."
    fi
fi

# 3. Port Availability
echo -e "\n${BOLD}[3/6] Checking Network Ports${NC}"
if command -v ss &> /dev/null; then
    ss -tunlp | grep ":3000" > /dev/null && echo -e "  [${GREEN}OK${NC}] Port 3000 (API) is active." || echo -e "  [${RED}FAIL${NC}] Port 3000 is unreachable."
    ss -tunlp | grep ":3306" > /dev/null && echo -e "  [${GREEN}OK${NC}] Port 3306 (DB) is active." || echo -e "  [${RED}FAIL${NC}] Port 3306 is unreachable."
else
    echo -e "  [${YELLOW}SKIP${NC}] 'ss' command not found, skipping port check."
fi

# 4. Database Credentials & Client
echo -e "\n${BOLD}[4/6] Testing Database Login${NC}"
DB_CLIENT=""
if command -v mariadb &> /dev/null; then
    DB_CLIENT="mariadb"
elif command -v mysql &> /dev/null; then
    DB_CLIENT="mysql"
fi

if [ -z "$DB_CLIENT" ]; then
    echo -e "  [${RED}FAIL${NC}] No DB client found (mariadb or mysql command missing)."
    echo -e "         ${YELLOW}HINT: Install with 'sudo apt install mariadb-client'${NC}"
else
    echo -e "  [${GREEN}OK${NC}] Found DB client: $DB_CLIENT"
    if [ "$RUN_MODE" == "DOCKER" ]; then
        DB_TEST=$(docker exec smartstock-db $DB_CLIENT -u "$ENV_DB_USER" -p"$ENV_DB_PASS" -e "SELECT 1;" 2>&1)
    else
        DB_TEST=$($DB_CLIENT -h "$DB_HOST_ACTUAL" -u "$ENV_DB_USER" -p"$ENV_DB_PASS" -e "SELECT 1;" 2>&1)
    fi

    if [ $? -eq 0 ]; then
        echo -e "  [${GREEN}OK${NC}] Database credentials verified."
    else
        echo -e "  [${RED}FAIL${NC}] DB Connection Error: $DB_TEST"
    fi
fi

# 5. Connectivity & DNS
echo -e "\n${BOLD}[5/6] Testing Internet & CDN Reachability${NC}"
if ping -c 1 8.8.8.8 &> /dev/null; then
    echo -e "  [${GREEN}OK${NC}] Global Internet reachability (8.8.8.8)."
else
    echo -e "  [${RED}FAIL${NC}] Cannot ping 8.8.8.8. Network interface might be down."
fi

ESM_STATUS=$(curl -s -o /dev/null -w "%{http_code}" https://esm.sh/react)
if [ "$ESM_STATUS" == "200" ]; then
    echo -e "  [${GREEN}OK${NC}] esm.sh (Frontend Modules) is reachable."
else
    echo -e "  [${RED}FAIL${NC}] esm.sh is unreachable (HTTP $ESM_STATUS)."
fi

# 6. Recent Logs
echo -e "\n${BOLD}[6/6] Inspecting Recent Errors${NC}"
if [ "$RUN_MODE" == "DOCKER" ]; then
    docker compose logs --tail=10 app
else
    echo -e "  [${CYAN}INFO${NC}] Native mode detected. Reviewing last 10 lines of standard output..."
fi

echo -e "\n${BOLD}====================================================${NC}"
echo -e "${BOLD}             Diagnosis Complete                     ${NC}"
echo -e "${BOLD}====================================================${NC}"
